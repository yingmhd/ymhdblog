---
layout: mypost
title: 前端性能优化
tags: 优化
---

要想网站响应的的快，主要要从`HTTP`下手，首先看一下网站的访问流程

### 网站访问流程

1. 浏览器拿到网址后，解析主机名，如`http://www.example.com/hello.html`解析出`www.example.com`
2. 根据主机名查找`IP`,先查询`hosts`文件，成功则返回其`ip`地址，如果没有查询到，就去`DNS服务器`（如果把`hosts`文件中`ip`对应的域名改为百度，那么输入百度的域名则会访问本机IP）
3. 三次握手建立连接
4. 客户端发送http请求
5. 服务器处理请求
6. 服务器返回响应

针对上面的步骤，可以针对三个阶段来优化，首先解析域名阶段，其次HTTP连接阶段，最后HTTP请求阶段。

### 域名解析阶段

对于大部分的用户来说，如果打开网站超过8秒钟，他可能就放弃访问了，对于商务网站，4秒就是用户极限了，这个阶段常用的优化策略有下面三种

#### 适当延长TTL（DNS缓存时间）
如果在缓存中可以找到IP，就不用去DNS服务器查询了，但是得注意，当IP变化了，从缓存中获取的错误IP将导致网站无法访问

#### 域名拆分
当浏览器访问相同量资源的时候，并发访问多个域名的时候比访问一个域名要快一些，所以把域名分成多个域名，把不同类型的资源放在不同的域名下，比如把图片放在一个域名下，把JS,CSS放在另外一个域名下

#### 使用CDN
这个一般要花钱，去CDN厂商买他们的服务。CDN就相当于京东的仓库一样，当我们想买完东西后，京东就会看我们的当前位置，然后从最近的仓库发货给我们，这样就省了很多时间。


### HTTP连接阶段

HTTP连接是单线程的，而且连接一次后就断开了，第二次请求的时候又得再连接一次，所以针对这个阶段的优化策略有：

#### 合并HTTP请求

常见策略有：

1. CSS雪碧图
2. 合并JS和CSS文件
3. HTTP缓存
4. 图片路径转换为BASE64（慎用，会增加请求资源的大小）
5. 图片懒加载（把img标签的src设置为一个默认图片，它真正的途径挂在它的属性`data-src`上，然后监听滚动事件，把即将看到的图片加载）

#### Keep-Alive

当在信息头里面设置`Connection： keep-alive`后，HTTP就可以保持一个长连接的状态，这样当第一个请求结束，发送第二个请求的时候就不需要三次握手，一般在服务器端设置`keepaliveTime`，当超过时间后，HTTP连接就会断开。

#### 启用HTTP/2

HTTP/2是自1999年HTTP1.1发布后得首个更新，基于SPDY协议，既然是新版本，那自然有厉害之处：

1. 多路复用（这下HTTP请求可以是多线程并发进行了，用不着一个一个排队了）
2. 二进制分帧（传输数据由文本格式编程二进制格式了，跑的更快了）
3. 服务器推送（这个就厉害了，当我们请求一个HTML的时候，服务器可以把它里面的引入的JS、CSS文件自动推送给客户端，就不需要再次去请求了）


### HTTP请求阶段

在这个阶段，最重要的是要尽可能的减少资源的大小，所以优化策略有：

1. 压缩CSS,JS,HTML
2. 使用工具压缩图片（比如 Optimus）
3. JS、CSS库文件可以通过`CDN`引用（https://www.bootcdn.cn/）
4. 使用GZIP

> GZIP
> 是最早用于`UNIX`系统的文件压缩。使用它的前提是web服务器和客户端都必须支持`gzip`。
> 它的工作原理：
> 1. 浏览器请求`url`，并在`request header`中设置属性`accept-encoding:gzip`，表明浏览器支持`gzip`
> 2. 服务器收到请求后，判断浏览器是否支持`gzip`，支持就返回压缩文件，`response headers`包含`content-encoding:gzip`，不支持则返回未压缩的内容
> 3. 客户端收到响应后判断内容是否被压缩，如果被压缩则解压显示内容

### 程序猿的优化

讲完了基本的优化，下面来讲讲程序猿平常开发中应该有的优化操作：

1. CSS放在HEAD里面
2. 将外部脚本置底
3. 异步请求Callback
4. 不要用`with`,`eval`和`new Function()`之类消耗资源的操作
5. 减少作用域链查找（比如一个函数里面要多次使用全局变量，那么就在函数内部定义一个变量把全局变量缓存下来）
6. 字符串拼接不要用`+`,每次都会开辟新的内存，取而代之用`join()`

## ENDING
暂时就这些，以后再添加。
